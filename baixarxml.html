<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar DANFe/DACTe - NF-e Viewer</title>
    <!-- Tailwind CSS para estilização moderna -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" />
    <!-- jQuery, Popper.js e Bootstrap JS para modais -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        /* Estilos personalizados para o layout e componentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container-card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        .btn-custom {
            /* Estilos Tailwind aplicados diretamente para botões */
            @apply bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition duration-300 ease-in-out flex items-center justify-center;
        }
        .btn-custom svg {
            margin-right: 8px;
        }
        .form-control-custom {
            /* Estilos Tailwind aplicados diretamente para textarea */
            @apply border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .modal-content {
            border-radius: 12px;
        }
        .modal-body {
            padding: 20px;
            font-size: 16px;
        }
        .modal-footer {
            border-top: none;
            padding: 15px 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-card">
        <h5 class="text-2xl font-semibold mb-4 text-gray-800">Gerar DANFe ou DACTe</h5>
        <p class="text-sm text-gray-600 mb-6">Insira o XML no campo abaixo ou consulte pela chave de acesso para converter para PDF (DANFe/DACTe).</p>
        
        <textarea class="form-control-custom mb-4" id="textXML" rows="8" placeholder="Cole o XML da NF-e ou CT-e aqui..."></textarea>
        
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mb-6">
            <button id="butGerar" type="button" class="btn-custom w-full sm:w-1/2">
                <i class="fas fa-file-upload"></i> Gerar a partir do XML
            </button>
            <button id="butConsultarChave" type="button" class="btn-custom w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-key"></i> Consultar pela Chave
            </button>
        </div>

        <!-- Container para as opções de download/visualização, inicialmente oculto -->
        <div id="optionsContainer" class="hidden mt-6 p-4 bg-gray-100 rounded-lg">
            <h6 class="text-lg font-semibold mb-3 text-gray-700">Opções para a Nota Fiscal:</h6>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="butBaixarXML" type="button" class="btn-custom w-full sm:w-1/3 bg-purple-600 hover:bg-purple-700">
                    <i class="fas fa-download"></i> Baixar XML
                </button>
                <button id="butVisualizarNota" type="button" class="btn-custom w-full sm:w-1/3 bg-indigo-600 hover:bg-indigo-700">
                    <i class="fas fa-eye"></i> Visualizar Nota
                </button>
                <button id="butGerarDanfeDacte" type="button" class="btn-custom w-full sm:w-1/3 bg-red-600 hover:bg-red-700">
                    <i class="fas fa-file-pdf"></i> Gerar DANFe/DACTe
                </button>
            </div>
        </div>

        <!-- Modal para mensagens informativas (MsgInf) -->
        <div class="modal fade" id="msg1" tabindex="-1" role="dialog" aria-labelledby="msg1Label" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body" id="msg1texto">
                        <!-- O conteúdo da mensagem será injetado aqui -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success rounded-lg" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para loader (Aguarde) -->
        <div class="modal fade" id="msg2" tabindex="-1" role="dialog" aria-labelledby="msg2Label" aria-hidden="true" data-keyboard="false" data-backdrop="static">
            <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Carregando...</span>
                        </div>
                        <p class="mt-3 text-gray-700">Aguarde...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inputs ocultos para comunicação com a extensão (via script.js) -->
    <input type="hidden" id="stringsFSistHtml" />
    <input type="hidden" id="stringsFSistLink" />
    <input type="hidden" id="stringsFSistDados" />
    <input type="hidden" id="stringsFSistXml" /> <!-- Adicionado para o conteúdo XML -->
    <input type="hidden" id="stringsFSIST_CONFIG" />

    <script>
        // Variáveis globais para armazenar a chave e o tipo de documento
        let chaveAcessoGlobal = '';
        let tipoDocumentoGlobal = ''; // 'NFe' ou 'CTe'

        document.addEventListener('DOMContentLoaded', function () {
            // Funções auxiliares para exibir/ocultar modais
            function MsgInf(msg) {
                $('#msg1texto').text(msg);
                $('#msg1').modal('show');
            }

            function Aguarde() {
                $('#msg2').modal('show');
            }

            function AguardeClose() {
                $('#msg2').modal('hide');
            }

            // Função para extrair a chave do XML (mantida do seu código original)
            function getChave(xml) {
                if (xml.includes(' Id="NFe')) {
                    tipoDocumentoGlobal = 'NFe';
                    return StrEntreStr(' Id="NFe', '"', xml);
                } else if (xml.includes(' Id="CTe')) {
                    tipoDocumentoGlobal = 'CTe';
                    return StrEntreStr(' Id="CTe', '"', xml);
                }
                tipoDocumentoGlobal = ''; // Reseta se nenhuma chave for encontrada
                return '';
            }

            // Função auxiliar para extrair string entre duas outras strings (mantida do seu código original)
            function StrEntreStr(str1, str2, str) {
                var ini = str.indexOf(str1);
                if (ini > -1) {
                    ini += str1.length;
                    var fim = str.indexOf(str2, ini);
                    if (fim > -1) {
                        var res = str.substring(ini, fim);
                        return res;
                    }
                }
                return '';
            }

            // Função para extrair mensagem de erro do HTML da SEFAZ (útil para depuração)
            function extractErrorMessage(htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const errorMessageElement = doc.getElementById('ctl00_ContentPlaceHolder1_lblMensagemErro');
                return errorMessageElement ? errorMessageElement.textContent.trim() : 'Erro desconhecido';
            }

            // Função para baixar o conteúdo XML como um arquivo
            function downloadXml(xmlContent, fileName) {
                const blob = new Blob([xmlContent], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName || `nota_fiscal_${chaveAcessoGlobal}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                MsgInf("XML baixado com sucesso!");
            }

            // Função para visualizar a nota (abre o XML em uma nova aba do navegador)
            function viewNote(xmlContent) {
                const blob = new Blob([xmlContent], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                URL.revokeObjectURL(url);
            }

            // Função para buscar o XML via proxy (se a consulta direta à SEFAZ falhar)
            async function fetchXmlViaProxy(chave, tipo) {
                console.log("fetchXmlViaProxy() chamada. Tentando obter XML via proxy...");
                Aguarde(); // Exibe o loader
                try {
                    const proxyUrl = 'https://nefinfo.onrender.com/proxy-sefaz-xml'; // URL do seu servidor proxy
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ chave: chave, tipo: tipo })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Erro ao obter XML via proxy: ${response.status} . Detalhes: ${errorText}`);
                        throw new Error(`Falha ao obter XML via proxy: ${errorText}`);
                    }

                    const result = await response.json();
                    if (result.xmlContent) {
                        console.log("XML obtido com sucesso via proxy.");
                        // Envia o XML recebido do proxy para a própria página via postMessage
                        // Isso simula o fluxo como se a extensão tivesse enviado o XML
                        window.postMessage({ type: "FSIST_XML_RECEIVED", content: btoa(result.xmlContent) }, "*");
                    } else {
                        throw new Error("Resposta do proxy não contém 'xmlContent'.");
                    }
                } catch (error) {
                    console.error("Erro em fetchXmlViaProxy:", error);
                    MsgInf("Não foi possível obter o XML via proxy: " + error.message);
                } finally {
                    AguardeClose(); // Oculta o loader
                }
            }

            // Função para exibir as opções de download/visualização/geração do DANFe/DACTe
            function showDownloadOptions(xmlContent) {
                document.getElementById('optionsContainer').classList.remove('hidden');
                
                // Configura o botão "Baixar XML"
                document.getElementById('butBaixarXML').onclick = function() {
                    downloadXml(xmlContent, `${chaveAcessoGlobal}.xml`);
                };

                // Configura o botão "Visualizar Nota"
                document.getElementById('butVisualizarNota').onclick = function() {
                    viewNote(xmlContent);
                };

                // Configura o botão "Gerar DANFe/DACTe"
                document.getElementById('butGerarDanfeDacte').onclick = async function() {
                    Aguarde(); // Exibe o loader
                    try {
                        const formData = new FormData();
                        const blob = new Blob([xmlContent], { type: 'text/xml' });
                        formData.append('arquivo', blob, `${chaveAcessoGlobal}.xml`);

                        const proxyPdfUrl = 'https://nefinfo.onrender.com/proxy-fsist-gerarpdf'; // URL do seu proxy para geração de PDF
                        const response = await fetch(proxyPdfUrl, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Falha ao gerar PDF via proxy: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        if (result.link) {
                            // Link para download do PDF gerado pela FSist
                            const pdfLink = `https://www.fsist.com.br/${result.link}`;
                            window.open(pdfLink, '_blank'); // Abre em nova aba
                            MsgInf("DANFe/DACTe gerado com sucesso! Abrindo em nova aba para download.");
                        } else {
                            throw new Error("Resposta do proxy não contém link para PDF.");
                        }
                    } catch (error) {
                        console.error("Erro ao gerar DANFe/DACTe:", error);
                        MsgInf("Não foi possível gerar DANFe/DACTe: " + error.message);
                    } finally {
                        AguardeClose(); // Oculta o loader
                    }
                };
            }

            // Listener para o botão "Gerar a partir do XML"
            document.getElementById('butGerar').addEventListener('click', function () {
                const xmlValue = document.getElementById('textXML').value;
                if (xmlValue) {
                    chaveAcessoGlobal = getChave(xmlValue);
                    if (chaveAcessoGlobal) {
                        // Se o XML for fornecido diretamente, exibe as opções imediatamente
                        showDownloadOptions(xmlValue);
                        MsgInf("XML carregado. Opções de download e geração disponíveis.");
                    } else {
                        MsgInf("XML inválido. Não foi possível extrair a chave de acesso.");
                    }
                } else {
                    MsgInf("Por favor, insira o XML no campo de texto.");
                }
            });

            // Listener para o botão "Consultar pela Chave"
            document.getElementById('butConsultarChave').addEventListener('click', function () {
                const chaveInput = document.getElementById('textXML').value; // Usa a mesma textarea para entrada da chave
                if (chaveInput && chaveInput.length === 44 && !isNaN(chaveInput)) {
                    chaveAcessoGlobal = chaveInput;
                    // Heurística simples para determinar o tipo de documento
                    tipoDocumentoGlobal = chaveInput.startsWith('35') ? 'NFe' : 'CTe'; 
                    Aguarde(); // Exibe o loader
                    // Envia mensagem para o script de background da extensão para abrir a janela da SEFAZ
                    chrome.runtime.sendMessage(
                        {
                            tipo: 'AbrirConsulta',
                            chave: chaveAcessoGlobal,
                            url: tipoDocumentoGlobal === 'NFe' ? 'https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g=' : 'https://www.cte.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=mCK/KoCqru0='
                        },
                        function(response) {
                            console.log("Comando para abrir janela da SEFAZ enviado.", response);
                            // A resposta do background.js para AbrirConsulta é apenas uma confirmação.
                            // O XML real virá via window.postMessage do script.js na janela da SEFAZ.
                        }
                    );
                } else {
                    MsgInf("Por favor, insira uma chave de acesso válida (44 dígitos numéricos) para consultar.");
                }
            });

            // Listener para mensagens recebidas do content script (script.js) via window.postMessage
            window.addEventListener('message', async function(event) {
                // Garante que a mensagem é da mesma janela (ou de uma fonte confiável, se você tivesse múltiplos iframes/janelas)
                if (event.source !== window) {
                    return;
                }
                console.log("Mensagem recebida da extensão:", event.data);

                if (event.data.type === 'FSIST_DATA_RECEIVED') {
                    AguardeClose(); // Oculta o loader
                    const data = JSON.parse(atob(event.data.content));
                    console.log("Extensão enviou dados (do formulário da SEFAZ):", data);
                    // Estes dados são tipicamente para submissão de formulário na página da SEFAZ, não o XML final.
                    // Se esta mensagem implica um captcha bem-sucedido, podemos tentar buscar o XML via proxy aqui.
                    // Por enquanto, o fluxo é que FSIST_CERTIFICADO_ERROR dispara o proxy.
                } else if (event.data.type === 'FSIST_CERTIFICADO_ERROR') {
                    AguardeClose(); // Oculta o loader
                    const htmlContent = atob(event.data.content);
                    console.error("Erro de Certificado (HTML): ", htmlContent);
                    MsgInf("Erro: " + extractErrorMessage(htmlContent) + ". Tentando obter o XML via proxy...");
                    // Dispara a busca via proxy se ocorrer erro de certificado
                    await fetchXmlViaProxy(chaveAcessoGlobal, tipoDocumentoGlobal);
                } else if (event.data.type === 'FSIST_XML_RECEIVED') {
                    AguardeClose(); // Oculta o loader
                    const xmlContent = atob(event.data.content);
                    console.log("XML recebido da extensão (via proxy ou direto):", xmlContent);
                    document.getElementById('textXML').value = xmlContent; // Coloca o XML na textarea
                    showDownloadOptions(xmlContent); // Exibe as novas opções
                    MsgInf("XML da nota fiscal obtido com sucesso!");
                }
            });

            // Listener para mensagens do background script (para configuração inicial do script.js)
            chrome.runtime.onMessage.addListener(
                function(request, sender, sendResponse) {
                    if (request.message === "set_config") {
                        document.getElementById('stringsFSIST_CONFIG').value = request.content;
                        console.log("Configuração FSIST recebida e definida.");
                        sendResponse({status: "OK"});
                    }
                    return true; // Mantém a porta de mensagem aberta para sendResponse assíncrono
                }
            );

            // Verificação inicial se já existe XML na textarea (ex: se o usuário colou manualmente)
            if (document.getElementById('textXML').value) {
                const xmlValue = document.getElementById('textXML').value;
                chaveAcessoGlobal = getChave(xmlValue);
                if (chaveAcessoGlobal) {
                    showDownloadOptions(xmlValue);
                }
            }
        });
    </script>
</body>
</html>

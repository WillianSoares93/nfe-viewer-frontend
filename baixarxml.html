<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download XML e PDF NF-e/CT-e</title>
  <!-- Link para o Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Estilos globais para o corpo da página e variáveis de cor */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa; /* Fundo cinza claro */
      color: #333; /* Cor de texto padrão */
      display: flex; /* Usar flexbox para o layout principal */
      flex-direction: column; /* Conteúdo em coluna */
      min-height: 100vh; /* Ocupa a altura total da viewport */
    }

    :root {
      --primary-orange: #f26522; /* Laranja principal */
      --primary-blue: #003366; /* Azul principal */
    }

    /* Estilos para títulos */
    h1, h4, h5 {
      font-weight: 600; /* Negrito */
      color: var(--primary-blue); /* Cor azul */
    }

    /* Estilos para o cabeçalho do card */
    .card-header {
      background-color: var(--primary-orange); /* Fundo laranja */
      color: white; /* Texto branco */
      font-weight: 500;
      border-bottom: 2px solid var(--primary-blue); /* Borda inferior azul */
    }

    /* Estilos para todos os cards */
    .card {
      border: 2px solid #adb5bd; /* Borda cinza mais escura */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sombra suave */
      border-radius: 8px; /* Bordas arredondadas */
    }

    /* Estilo para a sobreposição do loader (indicador de carregamento) */
    .loader-overlay {
      position: fixed; /* Fixado na tela */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Fundo semi-transparente */
      z-index: 9999; /* Acima de tudo */
      display: none; /* ESCONDIDO POR PADRÃO */
      flex-direction: column; /* Conteúdo em coluna */
      justify-content: center; /* Centraliza verticalmente */
      align-items: center; /* Centraliza horizontalmente */
      border-radius: 8px; /* Bordas arredondadas */
    }
    .loader-content { /* Novo estilo para centralizar o conteúdo do loader */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .loader {
      border: 8px solid #f3f3f3; /* Borda cinza clara */
      border-top: 8px solid var(--primary-orange); /* Borda superior laranja (para o spinner) */
      border-radius: 50%; /* Faz um círculo */
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite; /* Animação de rotação */
    }
    .loader-text {
      color: white; /* Texto branco */
      margin-top: 10px; /* Espaço entre o spinner e o texto */
      font-size: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Estilos para as seções de conteúdo (agora páginas separadas) */
    .content-section {
      padding: 40px 20px;
      flex-grow: 1; /* Permite que ocupe o espaço disponível */
      text-align: center; /* Centraliza o conteúdo da seção */
    }

    .content-section h1 {
      margin-bottom: 30px;
      text-align: center;
    }

    .content-section p {
      margin-bottom: 15px;
      text-align: justify; /* Justifica o texto para melhor leitura */
      max-width: 800px; /* Limita a largura do parágrafo */
      margin-left: auto; /* Centraliza o parágrafo */
      margin-right: auto; /* Centraliza o parágrafo */
    }

    .content-section ul {
        list-style-type: disc;
        margin-left: auto; /* Centraliza a lista */
        margin-right: auto; /* Centraliza a lista */
        max-width: 800px; /* Limita a largura da lista */
        padding-left: 40px; /* Ajusta o padding para a lista */
        text-align: justify; /* Justifica o texto da lista */
    }

    .content-section ul li {
        margin-bottom: 8px;
    }

    /* Estilo para o botão de voltar */
    .btn-back-to-main {
        margin-top: 20px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        transition: background-color 0.3s ease;
    }

    .btn-back-to-main:hover {
        background-color: #002244; /* Azul mais escuro no hover */
    }

    /* Estilos para o rodapé */
    .footer {
      background-color: var(--primary-blue);
      color: white;
      padding: 20px 15px;
      text-align: center;
      font-size: 0.9rem;
      margin-top: auto; /* Empurra o rodapé para o final da página */
    }

    .footer a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      transition: text-decoration 0.3s ease;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Estilo para o logo na navbar */
    .navbar-brand img {
      height: 30px; /* Altura do logo */
      margin-right: 10px; /* Espaçamento à direita do logo */
      border-radius: 4px; /* Bordas arredondadas para o logo na navbar */
      background-color: transparent; /* Fundo transparente para o logo */
      padding: 0; /* Remove o preenchimento */
    }

    /* Estilos do formulário de download */
    .download-form-container {
        max-width: 600px; /* Largura máxima para o formulário */
        margin: 0 auto; /* Centraliza o formulário */
        background-color: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        margin-top: 30px;
        margin-bottom: 30px;
    }

    .download-form-container h1 {
        color: var(--primary-blue);
        font-size: 2.2rem;
        margin-bottom: 15px;
    }

    .download-form-container #chave-description {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 30px;
    }

    .form-field-group {
        background: #ebeff1;
        color: #596364;
        margin-bottom: 27px;
        border-radius: 8px;
        overflow: hidden;
        display: flex; /* Usar flexbox para alinhar label e input */
        align-items: center;
        padding: 0 15px; /* Padding para o grupo */
    }

    .form-field-group label {
        flex-shrink: 0; /* Não encolher a label */
        margin-right: 10px; /* Espaçamento entre label e input */
        font-size: 18px;
        color: #596364;
    }

    .form-field-group input[type="text"],
    .form-field-group select {
        color: #596364;
        font-size: 18px;
        background: #ebeff1;
        line-height: 2.5rem;
        width: 100%;
        border: 0;
        outline: 0;
        padding: 0; /* Removido padding individual, agora no grupo */
        box-sizing: border-box;
    }

    .form-buttons button {
        cursor: pointer;
        border: 0px none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Segoe UI', sans-serif;
        color: white;
        background-color: var(--primary-orange);
        border-radius: 8px;
        transition: background-color 0.3s ease;
        margin: 0 5px; /* Espaçamento entre botões */
    }

    .form-buttons button:hover {
        background-color: #d85c1b;
    }

    /* Estilo para o logo na página de Download */
    .download-logo {
      max-width: 150px; /* Tamanho do logo */
      height: auto;
      margin-bottom: 20px; /* Espaçamento abaixo do logo */
      border-radius: 8px; /* Bordas arredondadas */
    }

    /* Estilos para o Modal de Mensagens Customizado */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .custom-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .custom-modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }

    .custom-modal-overlay.show .custom-modal-content {
        transform: translateY(0);
    }

    .custom-modal-content h2 {
        color: var(--primary-blue);
        margin-bottom: 15px;
        font-size: 1.8rem;
    }

    .custom-modal-content p {
        color: #555;
        margin-bottom: 25px;
        font-size: 1rem;
    }

    .custom-modal-buttons button {
        background-color: var(--primary-orange);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        margin: 0 5px;
        transition: background-color 0.3s ease;
    }

    .custom-modal-buttons button:hover {
        background-color: #d85c1b;
    }

    .custom-modal-buttons button.cancel-btn {
        background-color: #6c757d;
    }

    .custom-modal-buttons button.cancel-btn:hover {
        background-color: #5a6268;
    }

    /* Responsividade para telas menores */
    @media (max-width: 768px) {
      .content-section h1 {
        font-size: 1.5rem;
      }
      .footer a {
          display: block;
          margin: 5px 0;
      }
      .download-form-container {
        padding: 20px;
      }
      .form-field-group input,
      .form-field-group select {
        font-size: 16px;
        line-height: 2rem;
      }
      .form-buttons button {
        padding: 10px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #003366;">
    <div class="container">
      <a class="navbar-brand" href="/">
        NF-e Viewer
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Início</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/baixarxml.html">Download XML</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/sobre">Sobre</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/politica-de-privacidade">Política de Privacidade</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/termos-de-uso">Termos de Uso</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/contato">Contato</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Sobreposição do Loader (para mensagens de progresso) -->
  <div class="loader-overlay" id="loaderOverlay">
    <div class="loader-content">
        <div class="loader"></div>
        <p id="loaderText" class="loader-text">Carregando...</p>
    </div>
  </div>

  <!-- Modal de Mensagens Customizado (para MsgInf e MsgQue) -->
  <div id="customMessageModal" class="custom-modal-overlay">
      <div class="custom-modal-content">
          <h2 id="customModalTitle"></h2>
          <p id="customModalMessage"></p>
          <div class="custom-modal-buttons">
              <button id="customModalConfirmBtn" style="display: none;">Confirmar</button>
              <button id="customModalCloseBtn">Fechar</button>
          </div>
      </div>
  </div>

  <!-- Seção de Download -->
  <div id="download-section" class="content-section container">
    <div class="download-form-container">
        <img src="logo.png" alt="Logo NF-e Viewer" class="download-logo" onerror="this.onerror=null; this.src='https://placehold.co/150x150/003366/FFFFFF?text=Logo';">
        <h1 id="main-title">Baixar XML de NF-e/CT-e</h1>
        <div id="chave-description">Download de XML e DANFe com a chave.</div>

        <div id="divDados">
            <div class="form-field-group">
                <label for="chave">Chave de Acesso:</label>
                <input type="text" id="chave" placeholder="Digite a Chave de Acesso (44 dígitos)" maxlength="44" onkeyup="ContarCaracteres();">
            </div>
            
            <div class="form-field-group">
                <label for="tipoDocumento">Tipo:</label>
                <select id="tipoDocumento" onchange="TipoDocumentoSelecionado()">
                    <option value="NFe">NF-e (Nota Fiscal Eletrônica)</option>
                    <option value="CTe">CT-e (Conhecimento de Transporte Eletrônico)</option>
                </select>
            </div>

            <div class="form-buttons">
                <button onclick="consultarNota()">CONSULTAR NOTA</button>
                <button onclick="novaConsulta()">NOVA CONSULTA</button>
            </div>

            <!-- Div para exibir resultados da consulta (re-adicionada para os links de download) -->
            <div id="resultadoConsulta" style="display: none; margin-top: 20px;">
                <h4 style="color: var(--primary-blue);">Resultados da Consulta:</h4>
                <div class="form-buttons" style="margin-top: 15px;">
                    <button onclick="visualizarNota()">VISUALIZAR NOTA (PDF)</button>
                    <button onclick="downloadXml()">DOWNLOAD XML</button>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4">
        <button class="btn btn-back-to-main" onclick="window.location.href='/'">Voltar</button>
    </div>
  </div>

  <!-- Rodapé da Página -->
  <footer class="footer">
    <div>
      © 2025 NF-e Viewer. Todos os direitos reservados.
    </div>
    <div class="mt-2">
      <a href="/sobre">Sobre</a> |
      <a href="/politica-de-privacidade">Política de Privacidade</a> |
      <a href="/termos-de-uso">Termos de Uso</a> |
      <a href="/contato">Contato</a> |
      <a href="/baixarxml.html">Download XML</a>
    </div>
  </footer>

  <!-- Campos ocultos para comunicação com a extensão -->
  <input type="hidden" id="stringsFSistChave" value="">
  <input type="hidden" id="stringsFSistUrl" value="">
  <button type="button" id="stringsFSistClick" style="display: none;"></button> <!-- Changed to button -->
  <input type="hidden" id="stringsFSistHtml" value="">
  <input type="hidden" id="stringsFSistDados" value="">
  <input type="hidden" id="stringsFSistLink" value="">
  <input type="hidden" id="stringsFSistXml" value="">
  <input type="hidden" id="stringsFSIST_CONFIG" value="">
  <input type="hidden" id="stringsFSistVersao" value="">

  <!-- Link para o Bootstrap JS (com Popper.js) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Remover a URL do proxy, pois a comunicação será direta com a extensão
    // const PROXY_BASE_URL = 'https://nefinfo.onrender.com'; 

    function ele(id) {
        return document.getElementById(id);
    }

    // Referências aos elementos do modal customizado
    const customMessageModal = ele('customMessageModal');
    const customModalTitle = ele('customModalTitle');
    const customModalMessage = ele('customModalMessage');
    const customModalCloseBtn = ele('customModalCloseBtn');
    const customModalConfirmBtn = ele('customModalConfirmBtn');

    let currentMsgQueCallback = null;

    if (customModalCloseBtn) {
        customModalCloseBtn.addEventListener('click', () => {
            customMessageModal.classList.remove('show');
            if (currentMsgQueCallback && typeof currentMsgQueCallback.no === 'function') {
                currentMsgQueCallback.no();
            }
            currentMsgQueCallback = null;
        });
    }

    if (customModalConfirmBtn) {
        customModalConfirmBtn.addEventListener('click', () => {
            customMessageModal.classList.remove('show');
            if (currentMsgQueCallback && typeof currentMsgQueCallback.yes === 'function') {
                currentMsgQueCallback.yes();
            }
            currentMsgQueCallback = null;
        });
    }

    function MsgInf(message, callback) {
        if (customModalTitle) customModalTitle.textContent = "Informação";
        if (customModalMessage) customModalMessage.textContent = message;
        if (customModalConfirmBtn) customModalConfirmBtn.style.display = 'none';
        if (customModalCloseBtn) {
            customModalCloseBtn.textContent = 'Fechar';
            customModalCloseBtn.classList.remove('cancel-btn');
        }
        if (customMessageModal) customMessageModal.classList.add('show');

        const closeHandler = () => {
            customMessageModal.classList.remove('show');
            customModalCloseBtn.removeEventListener('click', closeHandler);
            if (callback) callback();
        };
        customModalCloseBtn.addEventListener('click', closeHandler);
    }

    function MsgQue(message, callbackYes, callbackNo) {
        if (customModalTitle) customModalTitle.textContent = "Confirmação";
        if (customModalMessage) customModalMessage.textContent = message;
        if (customModalConfirmBtn) {
            customModalConfirmBtn.textContent = 'Sim';
            customModalConfirmBtn.style.display = 'inline-block';
        }
        if (customModalCloseBtn) {
            customModalCloseBtn.textContent = 'Não';
            customModalCloseBtn.classList.add('cancel-btn');
        }
        if (customMessageModal) customMessageModal.classList.add('show');

        currentMsgQueCallback = { yes: callbackYes, no: callbackNo };
    }

    function MsgB(title) {
        const loaderOverlay = ele('loaderOverlay');
        const loaderText = ele('loaderText');
        if (loaderText) loaderText.textContent = title;
        if (loaderOverlay) loaderOverlay.style.display = 'flex';
    }

    function MsgF() {
        const loaderOverlay = ele('loaderOverlay');
        if (loaderOverlay) loaderOverlay.style.display = 'none';
    }

    // --- Funções Específicas da Página de Download ---

    function ContarCaracteres() {
        // Lógica de contagem de caracteres, se necessário.
    }

    function TipoDocumentoSelecionado() {
        // Lógica para ajustar a UI ou validação com base no tipo selecionado, se necessário
    }

    async function consultarNota() {
        const chave = ele('chave').value.trim();
        const tipoDocumento = ele('tipoDocumento').value;

        if (chave === '') {
            MsgInf('É necessário digitar a chave de acesso.');
            return;
        }
        if (chave.length !== 44) {
            MsgInf(`A chave informada tem ${chave.length} dígitos, mas deve ter 44 dígitos.`);
            return;
        }

        MsgB('Abrindo janela da SEFAZ via extensão...');

        try {
            // Preenche os campos ocultos que a extensão espera
            ele('stringsFSistChave').value = chave;
            
            let sefazUrl = '';
            if (tipoDocumento === 'NFe') {
                sefazUrl = `https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=completa&tipoConteudo=XbSeqxE8pl8=`;
            } else if (tipoDocumento === 'CTe') {
                sefazUrl = `https://www.cte.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=completa&tipoConteudo=mCK/KoCqru0=`;
            }
            ele('stringsFSistUrl').value = sefazUrl;

            // Simula o clique no botão oculto que a extensão está escutando
            ele('stringsFSistClick').click();

            // A extensão agora lidará com a abertura da janela e o reCAPTCHA.
            // A resposta (link PDF/XML) virá via chrome.runtime.onMessage.addListener

        } catch (error) {
            MsgF();
            console.error("Erro ao iniciar consulta via extensão:", error);
            MsgInf('Erro ao tentar se comunicar com a extensão. Certifique-se de que a extensão está instalada e ativa com as permissões corretas.');
        }
    }

    function visualizarNota() {
        if (window.fsistResult && window.fsistResult.linkPDF) {
            window.open(window.fsistResult.linkPDF, '_blank');
        } else {
            MsgInf('Nenhum link de PDF disponível para visualização.');
        }
    }

    function downloadXml() {
        if (window.fsistResult && window.fsistResult.linkXML) {
            window.open(window.fsistResult.linkXML, '_blank');
        } else {
            MsgInf('Nenhum link de XML disponível para download.');
        }
    }

    function novaConsulta() {
        ele('chave').value = '';
        ele('tipoDocumento').value = 'NFe';
        ele('resultadoConsulta').style.display = 'none'; // Esconde os resultados
        window.fsistResult = null;
        ele('chave').focus();
        MsgInf('Pronto para uma nova consulta!');
    }

    // --- Listener para mensagens da extensão ---
    // Este código DEVE estar dentro de um bloco que só é executado se `chrome.runtime` existir,
    // garantindo que não quebre em navegadores sem a extensão ou em outros ambientes.
    if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
        chrome.runtime.onMessage.addListener(
            function(request, sender, sendResponse) {        
                if (request.message === "set_html") {
                    // Se a extensão enviar HTML (pode ser uma página de erro da SEFAZ, por exemplo)
                    // Você pode decidir como exibir isso, talvez em um modal ou log.
                    console.log("Extensão enviou HTML:", atob(request.content));
                    MsgF(); // Esconde o loader
                    MsgInf("A extensão recebeu uma resposta HTML. Verifique os logs do console para detalhes.");
                    sendResponse({status: "success"});
                }
                else if (request.message === "set_dados") {
                    // A extensão pode enviar dados do formulário da SEFAZ
                    console.log("Extensão enviou dados:", atob(request.content));
                    MsgF(); // Esconde o loader
                    // Você pode processar esses dados se necessário, mas para o fluxo de download, não é direto.
                    sendResponse({status: "success"});
                }
                else if (request.message === "set_link") {
                    // A extensão enviou um link (provavelmente PDF)
                    MsgF(); // Esconde o loader
                    const decodedLink = atob(request.content);
                    console.log("Extensão enviou link:", decodedLink);
                    window.fsistResult = { linkPDF: decodedLink, linkXML: null }; // Armazena o link PDF
                    ele('resultadoConsulta').style.display = 'block'; // Mostra os botões
                    MsgInf('Link de PDF recebido da extensão. Você pode visualizar ou aguardar o XML.');
                    sendResponse({status: "success"});
                }
                else if (request.message === "set_xml") {
                    // A extensão enviou o XML (base64)
                    MsgF(); // Esconde o loader
                    const decodedXml = atob(request.content);
                    console.log("Extensão enviou XML:", decodedXml);
                    // Se já tiver linkPDF, mantém. Se não, define.
                    window.fsistResult = { ...window.fsistResult, linkXML: `data:application/xml;base64,${request.content}` }; // Armazena o XML como data URL
                    ele('resultadoConsulta').style.display = 'block'; // Mostra os botões
                    MsgInf('XML recebido da extensão. Você pode baixar o XML ou visualizar o PDF (se disponível).');
                    sendResponse({status: "success"});
                }
                // Adicione aqui outros tipos de mensagem que a extensão possa enviar
                else {
                    console.log("Mensagem desconhecida da extensão:", request.message, request.content);
                    sendResponse({status: "success"});
                }
            }
        );
    } else {
        console.warn("API 'chrome.runtime.onMessage' não disponível. A extensão pode não estar instalada ou ativa.");
        MsgInf("A extensão do navegador não foi detectada ou não está ativa. A funcionalidade de consulta pode não funcionar como esperado. Por favor, certifique-se de que a extensão está instalada e configurada para este site.");
    }


    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        ele('chave').focus();
    });
  </script>
</body>
</html>
```

**Próximos Passos Cruciais para Você:**

O erro "API 'chrome.runtime.onMessage' não disponível" indica que o `script.js` da extensão não está sendo injetado na sua página. Para resolver isso, você **precisa garantir que a extensão do FSist esteja configurada corretamente para o seu domínio**.

Por favor, siga estes passos com **extrema atenção**:

1.  **Modifique o `manifest.json` da Extensão do FSist:**
    * Localize a pasta onde você tem o código-fonte da extensão do FSist.
    * Abra o arquivo `manifest.json` com um editor de texto.
    * Encontre a seção `content_scripts`. Dentro dela, procure pela lista `matches`.
    * **Adicione o seu domínio** `https://nfeinfo.vercel.app/*` a essa lista.
        * **Exemplo:** Se a linha original for:
            ```json
            "matches": [ "https://www.nfe.fazenda.gov.br/*", "https://www.cte.fazenda.gov.br/*", "https://*.fsist.com.br/*" ]
            ```
            Você deve alterá-la para:
            ```json
            "matches": [ "https://www.nfe.fazenda.gov.br/*", "https://www.cte.fazenda.gov.br/*", "https://*.fsist.com.br/*", "https://nfeinfo.vercel.app/*" ]
            ```
            **Certifique-se de que não há erros de sintaxe JSON (vírgulas, aspas, etc.).**

2.  **Reinstale/Recarregue a Extensão Modificada no Seu Navegador:**
    * Abra o navegador Chrome.
    * Vá para `chrome://extensions` na barra de endereços e pressione Enter.
    * No canto superior direito, ative o **"Modo Desenvolvedor"**.
    * **Se a extensão do FSist já estiver instalada:**
        * Clique no botão de "recarregar" (uma seta circular) ao lado da extensão do FSist.
    * **Se a extensão do FSist não estiver instalada ou se você quiser garantir uma instalação limpa:**
        * Remova a versão existente da extensão do FSist (se houver).
        * Clique no botão **"Carregar sem compactação" (Load unpacked)**.
        * Navegue até a pasta onde você modificou o `manifest.json` e selecione essa pasta.
    * Verifique se a extensão está **ativada**.

**Sobre o segundo erro ("A listener indicated an asynchronous response..."):**

Este erro, como mencionei, provavelmente se origina no `background.js` da extensão. O problema é que em algumas partes do `background.js`, a função `sendResponse(true)` é chamada, mas o listener não está configurado para uma resposta assíncrona, ou a resposta assíncrona não está sendo tratada corretamente.

Para corrigir isso no `background.js` da extensão, você precisaria:

* **Identificar as chamadas `sendResponse(true)`:** No `background.js`, procure por linhas como `sendResponse(true);`.
* **Ajustar o retorno do listener:**
    * Se a `sendResponse` for chamada **imediatamente e de forma síncrona**, o listener **NÃO DEVE** retornar `true`. Ele deve apenas chamar `sendResponse(algum_valor_aqui);` e implicitamente retornar `undefined` (ou nada).
    * Se a `sendResponse` for chamada **posteriormente, de forma assíncrona** (por exemplo, dentro de um `fetch().then()` ou um `setTimeout()`), então o listener **DEVE** retornar `true` explicitamente para sinalizar ao Chrome que a resposta virá mais tarde.

Por exemplo, no `background.js` que você enviou, algumas partes como `sendResponse(true);` para `SetHtml`, `SetDados`, `Fechar`, `SetConfig` e o `else` final são problemáticas. Elas deveriam ser apenas `sendResponse({status: 'success'});` sem retornar `true` da função do listener, a menos que a `sendResponse` seja realmente assíncrona.

**Foco Principal:** Por favor, concentre-se primeiro em seguir os passos para modificar e reinstalar a extensão. Uma vez que o `script.js` esteja sendo injetado na sua página, o primeiro erro desaparecerá, e poderemos então ver o comportamento do fluxo de comunicação. Se o segundo erro persistir e for um problema funcional, você precisará aplicar as correções sugeridas no `background.js` da extens
